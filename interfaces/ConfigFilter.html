<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Sunbird Portal Documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">Sunbird Portal Documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li>Interfaces</li>
  <li
  >
  ConfigFilter</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/modules/program-dashboard/components/program-datasets/program-datasets.component.ts</code>
        </p>




        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#controlType" 
>
                                            controlType
                                        </a>
                                </li>
                                <li>
                                        <a href="#defaultValue" 
>
                                            defaultValue
                                        </a>
                                </li>
                                <li>
                                        <a href="#label" 
>
                                            label
                                        </a>
                                </li>
                                <li>
                                        <a href="#reference" 
>
                                            reference
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="controlType"></a>
                                        <span class="name "><b>controlType</b>
                                            <a href="#controlType">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>controlType:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="defaultValue"></a>
                                        <span class="name "><b>defaultValue</b>
                                            <a href="#defaultValue">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>defaultValue:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="label"></a>
                                        <span class="name "><b>label</b>
                                            <a href="#label">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>label:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="reference"></a>
                                        <span class="name "><b>reference</b>
                                            <a href="#reference">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>reference:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Component, OnDestroy, OnInit, ViewChild } from &#x27;@angular/core&#x27;;
import { INoResultMessage, ToasterService, IUserData, IUserProfile, LayoutService, ResourceService, ConfigService, OnDemandReportService } from &#x27;@sunbird/shared&#x27;;
import { TelemetryService } from &#x27;@sunbird/telemetry&#x27;;
import { Subject, Subscription, throwError ,Observable, of} from &#x27;rxjs&#x27;;
import { KendraService, UserService, FormService } from &#x27;@sunbird/core&#x27;;
import { mergeMap, switchMap, takeUntil,map, catchError } from &#x27;rxjs/operators&#x27;;
import { ActivatedRoute, Router } from &#x27;@angular/router&#x27;;
import { FormGroup, FormControl, Validators } from &#x27;@angular/forms&#x27;;
import * as _ from &#x27;lodash-es&#x27;;
import { Location } from &#x27;@angular/common&#x27;;
import { ReportService } from &#x27;../../../dashboard/services&#x27;;
import * as moment from &#x27;moment&#x27;;
import html2canvas from &#x27;html2canvas&#x27;;
import * as jspdf from &#x27;jspdf&#x27;;
const PRE_DEFINED_PARAMETERS &#x3D; [&#x27;$slug&#x27;, &#x27;hawk-eye&#x27;];
export interface ConfigFilter{
    label: string,
    controlType: string,
    reference: string,
    defaultValue: number
}
@Component({
  selector: &#x27;app-datasets&#x27;,
  templateUrl: &#x27;./program-datasets.component.html&#x27;,
  styleUrls: [&#x27;./program-datasets.component.scss&#x27;],
})
export class DatasetsComponent implements OnInit, OnDestroy {
  public activatedRoute: ActivatedRoute;
  public showConfirmationModal &#x3D; false;
  public dashboardReport$;
  public noResultMessage: INoResultMessage;
  public noResult: boolean;
  showPopUpModal: boolean;
  config;
  reportTypes &#x3D; [];
  programs &#x3D; [];
  solutions &#x3D; [];
  public message &#x3D; this.resourceService?.frmelmnts?.msg?.noDataDisplayed;
  instance: string;
  @ViewChild(&#x27;reportSection&#x27;) reportSection;
  public reportExportInProgress &#x3D; false;
  @ViewChild(&#x27;modal&#x27;, { static: false }) modal;
  popup &#x3D; false;
  awaitPopUp &#x3D; false;
  reportStatus &#x3D; {
    &#x27;submitted&#x27;: &#x27;SUBMITTED&#x27;,
    &#x27;processing&#x27;: &#x27;PROCESSING&#x27;,
    &#x27;failed&#x27;: &#x27;FAILED&#x27;,
    &#x27;success&#x27;: &#x27;SUCCESS&#x27;,
  };

  public isProcessed &#x3D; false;
  formData: Object;
  public columns &#x3D; [
    { name: &#x27;Report type&#x27;, isSortable: true, prop: &#x27;datasetConfig.title&#x27;, placeholder: &#x27;Filter report type&#x27; },
    { name: &#x27;Request date&#x27;, isSortable: true, prop: &#x27;jobStats.dtJobSubmitted&#x27;, placeholder: &#x27;Filter request date&#x27;, type: &#x27;date&#x27; },
    { name: &#x27;Status&#x27;, isSortable: false, prop: &#x27;status&#x27;, placeholder: &#x27;Filter status&#x27; },
    { name: &#x27;Report link&#x27;, isSortable: false, prop: &#x27;downloadUrls&#x27;, placeholder: &#x27;Filter download link&#x27; },
    { name: &#x27;Generated date&#x27;, isSortable: true, prop: &#x27;jobStats.dtJobCompleted&#x27;, placeholder: &#x27;Filter generated date&#x27;, type: &#x27;dateTime&#x27; },
  ];

  public onDemandReportData &#x3D; [];

  downloadCSV &#x3D; true;
  isColumnsSearchable &#x3D; false;
  tag: string;

  reportForm &#x3D; new FormGroup({
    programName: new FormControl(&#x27;&#x27;, [Validators.required]),
    solution: new FormControl(&#x27;&#x27;, [Validators.required]),
    reportType: new FormControl(&#x27;&#x27;, [Validators.required]),
    districtName: new FormControl(),
    organisationName: new FormControl(),
    startDate: new FormControl(),
    endDate: new FormControl()
  });

  passwordForm &#x3D; new FormGroup({
    password: new FormControl(&#x27;&#x27;, [Validators.minLength(8), Validators.required, Validators.pattern(&#x27;^(?&#x3D;.*[0-9])(?&#x3D;.*[a-zA-Z])([a-zA-Z0-9]+)$&#x27;)])
  });
  programSelected: any;
  solutionSelected: any;
  districts: any;
  organisations: any &#x3D; [];
  filter: any &#x3D; [];
  newData: boolean &#x3D; false;
  goToPrevLocation: boolean &#x3D; true;
  reportConfig: any;
  chartsReportData: any;
  lastUpdatedOn: any;
  exportOptions &#x3D; [&#x27;Pdf&#x27;, &#x27;Img&#x27;];
  hideElements: boolean &#x3D; false;
  globalDistrict: any;
  globalOrg: any;
  tabIndex: number;
  tableToCsv: boolean;
  hideTableToCsv:boolean &#x3D; true;
  minEndDate: any;  //Min end date - has to be one more than start date 
  maxEndDate: any;  //Max end date -  current date has to be max
  maxStartDate: any; //Start date - has to be one day less than end date
  displayFilters:any &#x3D; {};
  loadash &#x3D; _;
  pdFilters:ConfigFilter[] &#x3D; [];
  configuredFilters:any &#x3D; {}
  constructor(
    activatedRoute: ActivatedRoute,
    public layoutService: LayoutService,
    public telemetryService: TelemetryService,
    public resourceService: ResourceService,
    public kendraService: KendraService,
    public userService: UserService,
    public onDemandReportService: OnDemandReportService,
    config: ConfigService,
    public toasterService: ToasterService,
    public formService: FormService,
    public router: Router,
    public location: Location,
    public reportService: ReportService
  ) {
    this.config &#x3D; config;
    this.activatedRoute &#x3D; activatedRoute;
  }

  layoutConfiguration: any;
  public unsubscribe$ &#x3D; new Subject&lt;void&gt;();
  userDataSubscription: Subscription;
  /**
   * Reference of User Profile interface
   */
  userProfile: IUserProfile;
  /**
   * all user role
   */
  public userRoles: Array&lt;string&gt; &#x3D; [];
  public userId: string;
  public selectedReport;
  public selectedSolution: string;

  getProgramsList() {
    const paramOptions &#x3D; {
      url:
        this.config.urlConFig.URLS.KENDRA.PROGRAMS_BY_PLATFORM_ROLES + &#x27;?role&#x3D;&#x27; + this.userRoles.toString()
    };
    this.kendraService.get(paramOptions).pipe(takeUntil(this.unsubscribe$)).subscribe(data &#x3D;&gt; {
      if (data &amp;&amp; data.result) {
        this.programs &#x3D; data.result;
      }
    }, error &#x3D;&gt; {
      this.toasterService.error(_.get(this.resourceService, &#x27;messages.fmsg.m0004&#x27;));
    });

  }

  getSolutionList(program) {

    const paramOptions &#x3D; {
      url:
        this.config.urlConFig.URLS.KENDRA.SOLUTIONS_BY_PROGRAMID + &#x27;/&#x27; + program._id + &#x27;?role&#x3D;&#x27; + program.role[0]
    };
    this.kendraService.get(paramOptions).pipe(takeUntil(this.unsubscribe$)).subscribe(data &#x3D;&gt; {
      if (data &amp;&amp; data.result) {
        this.solutions &#x3D; data.result;
      }
    }, error &#x3D;&gt; {
      this.toasterService.error(_.get(this.resourceService, &#x27;messages.fmsg.m0004&#x27;));
    });

  }

  getDistritAndOrganisationList() {

    const paramOptions &#x3D; {
      url:
        this.config.urlConFig.URLS.KENDRA.DISTRICTS_AND_ORGANISATIONS + &#x27;/&#x27; + this.reportForm.controls.solution.value
    };
    this.kendraService.get(paramOptions).pipe(takeUntil(this.unsubscribe$)).subscribe(data &#x3D;&gt; {
      if (data &amp;&amp; Object.keys(data.result).length) {
        this.districts &#x3D; data.result.districts;
        if (data.result.organisations) {
          data.result.organisations.map(org &#x3D;&gt; {
            if (org?.orgName !&#x3D;&#x3D; null) {
              this.organisations.push(org)
            }
          });
        }
      }
    }, error &#x3D;&gt; {
      this.toasterService.error(_.get(this.resourceService, &#x27;messages.fmsg.m0004&#x27;));
    });

  }

  initLayout() {
    this.layoutConfiguration &#x3D; this.layoutService.initlayoutConfig();
    this.layoutService.switchableLayout().pipe(takeUntil(this.unsubscribe$)).subscribe(layoutConfig &#x3D;&gt; {
      if (layoutConfig !&#x3D; null) {
        this.layoutConfiguration &#x3D; layoutConfig.layout;
      }
    });
  }

  ngOnInit() {
    this.showPopUpModal &#x3D; true;
    this.instance &#x3D; _.upperCase(this.resourceService.instance || &#x27;SUNBIRD&#x27;);
    this.userDataSubscription &#x3D; this.userService.userData$.subscribe(
      (user: IUserData) &#x3D;&gt; {
        if (user &amp;&amp; !user.err) {
          this.userProfile &#x3D; user.userProfile;
          this.userRoles &#x3D; user.userProfile.userRoles;
          this.userId &#x3D; user.userProfile.id;

        }
      });
    this.initLayout();
    this.getProgramsList();
    this.getFormDetails();
    this.timeRangeInit();
  }

  timeRangeInit() {
    const currentYear &#x3D; new Date().getFullYear();
    const currentMonth &#x3D; new Date().getMonth();
    const today &#x3D; new Date().getDate();
    this.minEndDate &#x3D; new Date(currentYear - 100, 0, 1);
    this.maxEndDate &#x3D; new Date(currentYear + 0, currentMonth, today);
    this.maxStartDate &#x3D; new Date(currentYear + 0, currentMonth, today - 1);
  }

  public resolveParameterizedPath(path: string, explicitValue?: string): string {
    return _.reduce(PRE_DEFINED_PARAMETERS, (result: string, parameter: string) &#x3D;&gt; {
      if (_.includes(result, parameter)) {
        result &#x3D; _.replace(result, parameter, explicitValue);
      }
      return result;
    }, path);
  }

  public getUpdatedParameterizedPath(dataSources) {
    const explicitValue &#x3D; _.get(this.reportForm, &#x27;controls.solution.value&#x27;)
    return _.map(dataSources, (dataSource) &#x3D;&gt; ({
      id: dataSource.id,
      path: this.resolveParameterizedPath(dataSource.path, explicitValue)
    }));
  }
  
  selectedTabChange(event) {
    this.tabIndex &#x3D; event.index;
  }

  public programSelection($event) {
    this.reportForm.reset();
    this.displayFilters &#x3D; {};
    this.districts &#x3D; []
    this.organisations &#x3D; [];
    const program &#x3D; this.programs.filter(data &#x3D;&gt; {
      if (data._id &#x3D;&#x3D; $event.value) {
        return data;
      }
    });
    this.solutions &#x3D; [];
    this.reportTypes &#x3D; [];
    this.onDemandReportData &#x3D; [];
    this.resetConfigFilters();
    this.getSolutionList(program[0]);
    this.displayFilters[&#x27;Program&#x27;] &#x3D; [program[0].name]
    this.reportForm.controls.programName.setValue($event.value);
    this.newData &#x3D; true;
    this.globalDistrict &#x3D; this.globalOrg &#x3D; undefined;
  }

  public selectSolution($event) {
    this.newData &#x3D; false;
    this.noResult &#x3D; false;
    this.districts &#x3D; []
    this.organisations &#x3D; [];
    this.resetConfigFilters();
    delete this.displayFilters[&#x27;District&#x27;];
    delete this.displayFilters[&#x27;Organisation&#x27;];
    this.globalDistrict &#x3D; this.globalOrg &#x3D; undefined;
    if (this.programSelected &amp;&amp; this.reportForm.value &amp;&amp; this.reportForm.value[&#x27;solution&#x27;]) {
      const solution &#x3D; this.solutions.filter(data &#x3D;&gt; {
        if (data._id &#x3D;&#x3D; $event.value) {
          return data;
        }
      });
      this.tag &#x3D; solution[0]._id + &#x27;_&#x27; + this.userId;
      this.loadReports();

      const program &#x3D; this.programSelected;
      this.reportForm.reset();
      this.reportForm.controls.solution.setValue($event.value);
      this.reportForm.controls.programName.setValue(program);
      this.displayFilters[&#x27;Resource&#x27;] &#x3D; [$event?.source?.triggerValue]
      if (solution[0].isRubricDriven &#x3D;&#x3D;&#x3D; true &amp;&amp; solution[0].type &#x3D;&#x3D;&#x3D; &#x27;observation&#x27;) {
        const type &#x3D; solution[0].criteriaLevelReport ? solution[0].type + &#x27;_with_rubric&#x27; : solution[0].type + &#x27;_with_rubric_no_criteria_level_report&#x27;
        this.getReportTypes(this.programSelected, type);
      } else {
        this.getReportTypes(this.programSelected, solution[0].type);
      }
      this.getDistritAndOrganisationList();


    }
  }

  public getReportTypes(programId, solutionType) {
    this.reportTypes &#x3D; [];
    let selectedProgram &#x3D; this.programs.filter(program &#x3D;&gt; program._id &#x3D;&#x3D; programId);
    if (selectedProgram &amp;&amp; selectedProgram[0]) {
      let role &#x3D; selectedProgram[0][&#x27;role&#x27;];
      let types &#x3D; this.formData[solutionType];

      let filtersForReport &#x3D; {
        &quot;reportconfig.report_type&quot;: &quot;program_dashboard&quot;,
        &quot;reportconfig.solution_type&quot;: &#x60;${(solutionType &#x3D;&#x3D;&#x3D; &#x27;improvementProject&#x27;) ? &quot;project&quot; : solutionType}&#x60;,
        &quot;reportconfig.report_status&quot;: &quot;active&quot;
      }

      this.dashboardReport$ &#x3D; this.renderReport(filtersForReport).pipe(
        catchError(err &#x3D;&gt; {
          console.error(&#x27;Error while rendering report&#x27;, err);
          this.noResultMessage &#x3D; {
            &#x27;messageText&#x27;: _.get(err, &#x27;messageText&#x27;) || &#x27;messages.stmsg.m0131&#x27;
          };
          this.noResult &#x3D; true;
          return of({});
        })
      );

      if (types &amp;&amp; types.length &gt; 0) {
        types.forEach(element &#x3D;&gt; {
          let roleMatch &#x3D; role.some(e &#x3D;&gt; element.roles.includes(e));
          if (roleMatch) {
            this.reportTypes.push(element);
          }
        });
      }
    }
  }

  fetchConfig(filters): Observable&lt;any&gt; {
    return this.reportService.listAllReports(filters).pipe(
      mergeMap(apiResponse &#x3D;&gt; {
        const report &#x3D; _.get(apiResponse, &#x27;reports&#x27;);
        return report ? of(_.head(report)) : throwError(&#x27;No report found&#x27;);
      })
    );
  }

  renderReport(reportId): Observable&lt;any&gt; {
    return this.fetchConfig(reportId).pipe(switchMap(
      (report &#x3D;&gt; {
        const reportConfig &#x3D; this.reportConfig &#x3D; _.get(report, &#x27;reportconfig&#x27;);
        const dataSource &#x3D; _.get(reportConfig, &#x27;dataSource&#x27;) || [];
        let updatedDataSource &#x3D; _.isArray(dataSource) ? dataSource : [{ id: &#x27;default&#x27;, path: dataSource }];
        updatedDataSource &#x3D; this.getUpdatedParameterizedPath(updatedDataSource);
        const charts &#x3D; _.get(reportConfig, &#x27;charts&#x27;), tables &#x3D; _.get(reportConfig, &#x27;table&#x27;)
        return this.reportService.downloadMultipleDataSources(updatedDataSource).pipe(map((apiResponse) &#x3D;&gt; {
          const data &#x3D; apiResponse;
          const result: any &#x3D; Object.assign({});
          const chart &#x3D; (charts &amp;&amp; this.reportService.prepareChartData(charts, data, updatedDataSource,
            _.get(reportConfig, &#x27;reportLevelDataSourceId&#x27;))) || [];
          result[&#x27;charts&#x27;] &#x3D; chart;
          result[&#x27;tables&#x27;] &#x3D; (tables &amp;&amp; this.prepareTableData(tables, data, _.get(reportConfig, &#x27;downloadUrl&#x27;))) || [];
          this.hideTableToCsv &#x3D; (result?.tables[0]?.data !&#x3D; undefined) ? true : false;
          result[&#x27;reportMetaData&#x27;] &#x3D; reportConfig;
          result[&#x27;lastUpdatedOn&#x27;] &#x3D; this.reportService.getFormattedDate(this.reportService.getLatestLastModifiedOnDate(data));
          this.lastUpdatedOn &#x3D; moment(_.get(result, &#x27;lastUpdatedOn&#x27;)).format(&#x27;DD-MMMM-YYYY&#x27;);
          this.chartsReportData &#x3D; JSON.parse(JSON.stringify(result));
          return result;
        }))
      })
    ))
  }

  prepareTableData(tablesArray: any, data: any, downloadUrl: string): Array&lt;{}&gt; {
    tablesArray &#x3D; _.isArray(tablesArray) ? tablesArray : [tablesArray];
    return _.map(tablesArray, table &#x3D;&gt; {
      const tableId &#x3D; _.get(table, &#x27;id&#x27;) || &#x60;table-${_.random(1000)}&#x60;;
      const dataset &#x3D; this.getTableData(data, _.get(table, &#x27;id&#x27;));
      const tableData: any &#x3D; {};
      tableData.id &#x3D; tableId;
      tableData.name &#x3D; _.get(table, &#x27;name&#x27;) || &#x27;Table&#x27;;
      tableData.config &#x3D; _.get(table, &#x27;config&#x27;) || false;
      tableData.data &#x3D; dataset.data;
      let columns &#x3D; []
      tableData.header &#x3D; _.get(table, &#x27;columns&#x27;) || _.get(dataset, _.get(table, &#x27;columnsExpr&#x27;));
      tableData.header &amp;&amp; tableData.header.map((col) &#x3D;&gt; {
        let obj &#x3D; { title: col, data: col }
        columns.push(obj);
      })
      tableData.columnsConfiguration &#x3D; {
        columnConfig: columns,
        bLengthChange: true,
        info: true,
        lengthMenu: [10, 25, 50, 100],
        paging: true,
        searchable: true
      }
      tableData.downloadUrl &#x3D; this.resolveParameterizedPath(_.get(table, &#x27;downloadUrl&#x27;) || downloadUrl, _.get(this.reportForm, &#x27;controls.solution.value&#x27;));
      return tableData;

    });
  }

  getTableData(data: { result: any, id: string }[], tableId) {
    if (data.length &#x3D;&#x3D;&#x3D; 1) {
      const [dataSource] &#x3D; data;
      if (dataSource.id &#x3D;&#x3D;&#x3D; &#x27;default&#x27;) {
        return dataSource.result;
      }
    }
    return this.getDataSourceById(data, tableId) || {};
  }

  getDataSourceById(dataSources: { result: any, id: string }[], id: string &#x3D; &#x27;default&#x27;) {
    return _.get(_.find(dataSources, [&#x27;id&#x27;, id]), &#x27;result&#x27;);
  }

  downloadReport(reportType) {
    this.reportExportInProgress &#x3D; true;
    this.toggleHtmlVisibilty(true);
    setTimeout(() &#x3D;&gt; {
      switch (_.toLower(_.get(reportType, &#x27;value&#x27;))) {
        case &#x27;img&#x27;: {
          this.downloadReportAsImage();
          break;
        }
        case &#x27;pdf&#x27;: {
          this.downloadReportAsPdf();
          break;
        }
      }
    })
  }

  private convertHTMLToCanvas(element, options) {
    return html2canvas(element, options);
  }

  downloadReportAsPdf() {
    this.convertHTMLToCanvas(this.reportSection.nativeElement, {
      scrollX: 0,
      scrollY: -window.scrollY,
      scale: 2
    }).then(canvas &#x3D;&gt; {
      const imageURL &#x3D; canvas.toDataURL(&#x27;image/jpeg&#x27;);
      const pdfFormat &#x3D; new jspdf(&#x27;p&#x27;, &#x27;px&#x27;, &#x27;a4&#x27;);
      const docWidth &#x3D; pdfFormat.internal.pageSize.getWidth();
      const imageHeight &#x3D; (canvas.height * docWidth) / canvas.width;
      pdfFormat.internal.pageSize.setHeight(imageHeight);
      pdfFormat.addImage(imageURL, &#x27;JPEG&#x27;, 10, 8, docWidth - 28, imageHeight - 24);
      pdfFormat.save(&#x27;report.pdf&#x27;);
      this.toggleHtmlVisibilty(false);
      this.reportExportInProgress &#x3D; false;
    }).catch(_err &#x3D;&gt; {
      this.toggleHtmlVisibilty(false);
      this.reportExportInProgress &#x3D; false;
    });
  }

  downloadReportAsImage() {
    this.convertHTMLToCanvas(this.reportSection.nativeElement, {
      scrollX: 0,
      scrollY: -window.scrollY,
      scale: 2
    }).then(canvas &#x3D;&gt; {
      const imageURL &#x3D; canvas.toDataURL(&#x27;image/jpeg&#x27;);
      const anchorElement &#x3D; document.createElement(&#x27;a&#x27;);
      anchorElement.href &#x3D; imageURL.replace(&#x27;image/jpeg&#x27;, &#x27;image/octet-stream&#x27;);
      anchorElement.download &#x3D; &#x27;report.jpg&#x27;;
      anchorElement.click();
      this.toggleHtmlVisibilty(false);
      this.reportExportInProgress &#x3D; false;
    }).catch(_err &#x3D;&gt; {
      this.toggleHtmlVisibilty(false);
      this.reportExportInProgress &#x3D; false;
    });
  }

  private toggleHtmlVisibilty(flag: boolean): void {
    this.hideElements &#x3D; flag;
  }

  public closeModal(): void {
    this.popup &#x3D; false;
  }

  public csvRequest() {
    this.popup &#x3D; false;
    this.submitRequest();
  }

  public requestDataset() {
    if (this.selectedReport.encrypt &#x3D;&#x3D; true) {
      this.popup &#x3D; true;
    } else {
      this.showConfirmationModal &#x3D; true;
    }
  }

  private closeConfirmationModal() {
    this.showConfirmationModal &#x3D; false;
  }

  goBack() {
    this.goToPrevLocation ? this.location.back() : (this.showPopUpModal &#x3D; false);
  }

  confirm() {
    this.showPopUpModal &#x3D; false;
  }
  public handleConfirmationEvent(event: boolean) {
    this.closeConfirmationModal();
    if (event &#x3D;&#x3D; true) {
      this.submitRequest();
    }
  }
  public closeConfirmModal() {
    this.awaitPopUp &#x3D; false;
  }

  public resetFilter() {
    this.reportForm.reset();
    this.filter &#x3D; [];
    this.districts &#x3D; [];
    this.organisations &#x3D; [];
    this.solutions &#x3D; [];
    this.reportTypes &#x3D; [];
    this.onDemandReportData &#x3D; [];
    this.goToPrevLocation &#x3D; false;
    this.showPopUpModal &#x3D; true;
    this.globalDistrict &#x3D; this.globalOrg &#x3D; undefined;
    this.displayFilters &#x3D; {};
    this.timeRangeInit();
    this.resetConfigFilters();
  }

  loadReports() {
    this.onDemandReportService.getReportList(this.tag).subscribe((data) &#x3D;&gt; {
      if (data) {
        const reportData &#x3D; _.get(data, &#x27;result.jobs&#x27;);
        this.onDemandReportData &#x3D; _.map(reportData, (row) &#x3D;&gt; this.dataModification(row));
      }
    }, error &#x3D;&gt; {
      this.toasterService.error(_.get(this.resourceService, &#x27;messages.fmsg.m0004&#x27;));
    });
  }

  districtSelection($event) {
    this.globalDistrict &#x3D; $event.value;
    this.reportForm.controls.districtName.setValue($event.value);
    this.displayFilters[&#x27;District&#x27;] &#x3D; [$event?.source?.triggerValue]
    this.tag &#x3D;  _.get(this.reportForm, &#x27;controls.solution.value&#x27;)+ &#x27;_&#x27; + this.userId+&#x27;_&#x27;+ _.toLower(_.trim([$event?.source?.triggerValue],&quot; &quot;));
    this.reportForm.controls.reportType.setValue(&#x27;&#x27;);
    this.resetConfigFilters();
    this.loadReports();
  }

  organisationSelection($event) {
    this.globalOrg &#x3D; $event.value
    this.reportForm.controls.organisationName.setValue($event.value);
    this.displayFilters[&#x27;Organisation&#x27;] &#x3D; [$event?.source?.triggerValue]
  }

  reportChanged(selectedReportData) {
    this.resetConfigFilters();
    this.selectedReport &#x3D; selectedReportData;
    if(this.selectedReport.configurableFilters){
      this.pdFilters &#x3D; this.selectedReport.uiFilters;
      this.pdFilters.map(filter &#x3D;&gt; {
        if(filter[&#x27;controlType&#x27;] &#x3D;&#x3D;&#x3D; &#x27;number&#x27;){
          this.configuredFilters[filter[&#x27;reference&#x27;]] &#x3D; filter[&#x27;defaultValue&#x27;] as number -1
        }else if(filter[&#x27;controlType&#x27;] &#x3D;&#x3D;&#x3D; &#x27;multi-select&#x27;){
          this.configuredFilters[filter[&#x27;reference&#x27;]] &#x3D; undefined
        }
      })
    }
  }
  
  resetConfigFilters(){
    this.pdFilters &#x3D; [];
    this.configuredFilters &#x3D; {};
  }

  pdFilterChanged($event){
    if($event.data){
      const [reference, value]&#x3D; [Object.keys($event.data),Object.values($event.data)] ;
      if($event.controlType &#x3D;&#x3D;&#x3D; &#x27;number&#x27;){
        if([0,null].includes(value[0] as number) || value[0] &lt; 0){
          this.configuredFilters[reference[0]] &#x3D; undefined;
        }else{
          this.configuredFilters[reference[0]] &#x3D; value[0] as number -1;
        }
      }else if($event.controlType &#x3D;&#x3D;&#x3D; &#x27;multi-select&#x27;){
          if((value[0] as string[]).length){
            this.configuredFilters[reference[0]] &#x3D; value[0]
          }else{
            this.configuredFilters[reference[0]] &#x3D; undefined;
          }
      }
    }
  }

  addFilters() {
    this.pdFilters.map(filter &#x3D;&gt; {
     if(filter[&#x27;controlType&#x27;] &#x3D;&#x3D;&#x3D; &#x27;multi-select&#x27; &amp;&amp; this.configuredFilters[filter[&#x27;reference&#x27;]] &#x3D;&#x3D;&#x3D; undefined){
      this.configuredFilters[filter[&#x27;reference&#x27;]] &#x3D; filter[&#x27;options&#x27;]
      }
    })
    let filterKeysObj &#x3D; {
      program_id: _.get(this.reportForm, &#x27;controls.programName.value&#x27;),
      solution_id: _.get(this.reportForm, &#x27;controls.solution.value&#x27;),
      programId: _.get(this.reportForm, &#x27;controls.programName.value&#x27;),
      solutionId: _.get(this.reportForm, &#x27;controls.solution.value&#x27;),
      district_externalId: _.get(this.reportForm, &#x27;controls.districtName.value&#x27;) || undefined,
      organisation_id: _.get(this.reportForm, &#x27;controls.organisationName.value&#x27;) || undefined,
      ...this.configuredFilters
    }

    let keys &#x3D; Object.keys(filterKeysObj);

    this.selectedReport[&#x27;filters&#x27;].map(data &#x3D;&gt; {
      keys.filter(key &#x3D;&gt; {
        return data.dimension &#x3D;&#x3D;&#x3D; key &amp;&amp; (_.has(data,&#x27;value&#x27;) ? data.value &#x3D; filterKeysObj[key] : data.values &#x3D; filterKeysObj[key]);
      })
      if (data.value !&#x3D;&#x3D; undefined || data.values !&#x3D;&#x3D; undefined) {
        this.filter.push(data);
      }
    });
  }
  submitRequest() {
    this.addFilters();
    this.selectedSolution &#x3D; this.reportForm.controls.solution.value;
    const isRequestAllowed &#x3D; this.checkStatus();
    if (isRequestAllowed) {
      this.isProcessed &#x3D; false;
      const config &#x3D; {
        type: this.selectedReport[&#x27;datasetId&#x27;],
        params: {
          ...(_.get(this.reportForm, &#x27;controls.startDate.value&#x27;) &amp;&amp; { &#x27;start_date&#x27;: _.get(this.reportForm, &#x27;controls.startDate.value&#x27;) }),
          ...(_.get(this.reportForm, &#x27;controls.endDate.value&#x27;) &amp;&amp; { &#x27;end_date&#x27;: _.get(this.reportForm, &#x27;controls.endDate.value&#x27;) }),
          filters: this.filter
        },
        title: this.selectedReport.name
      };
      const request &#x3D; {
        request: {
          dataset: &#x27;druid-dataset&#x27;,
          tag: this.tag,
          requestedBy: this.userId,
          datasetConfig: config,
          output_format: &#x27;csv&#x27;

        }
      };

      if (this.selectedReport.encrypt &#x3D;&#x3D;&#x3D; true) {
        request.request[&#x27;encryptionKey&#x27;] &#x3D; this.passwordForm.controls.password.value;
      }

      this.onDemandReportService.submitRequest(request).subscribe((data: any) &#x3D;&gt; {
        if (data &amp;&amp; data.result) {
          if (data.result.status &#x3D;&#x3D;&#x3D; this.reportStatus.failed) {
            const error &#x3D; _.get(this.resourceService, &#x27;frmelmnts.lbl.reportRequestFailed&#x27;);
            this.toasterService.error(error);
          } else {

            if (data[&#x27;result&#x27;] &amp;&amp; data[&#x27;result&#x27;][&#x27;requestId&#x27;]) {

              const dataFound &#x3D; this.onDemandReportData.filter(function (submittedReports) {
                if (submittedReports[&#x27;requestId&#x27;] &#x3D;&#x3D; data[&#x27;result&#x27;][&#x27;requestId&#x27;]) {
                  return data;
                }

              });
              if (dataFound &amp;&amp; dataFound.length &gt; 0) {
                this.popup &#x3D; false;
                this.isProcessed &#x3D; true;
                setTimeout(() &#x3D;&gt; {
                  this.isProcessed &#x3D; false;
                }, 5000);
                this.toasterService.error(_.get(this.resourceService, &#x27;frmelmnts.lbl.reportRequestFailed&#x27;));
                this.passwordForm.reset();

              } else {
                data &#x3D; this.dataModification(data[&#x27;result&#x27;]);
                const updatedReportList &#x3D; [data, ...this.onDemandReportData];
                this.onDemandReportData &#x3D; updatedReportList;
                this.awaitPopUp &#x3D; true;
                this.passwordForm.reset();

              }
            }
          }

        }
      }, error &#x3D;&gt; {
        this.toasterService.error(_.get(this.resourceService, &#x27;messages.fmsg.m0004&#x27;));
      });
      this.filter &#x3D; [];

    } else {
      this.popup &#x3D; false;
      this.isProcessed &#x3D; true;
      this.filter &#x3D; [];
      setTimeout(() &#x3D;&gt; {
        this.isProcessed &#x3D; false;
      }, 5000);
      this.toasterService.error(_.get(this.resourceService, &#x27;frmelmnts.lbl.reportRequestFailed&#x27;));
      this.passwordForm.reset();
    }
  }

  public getFormDetails() {

    const formServiceInputParams &#x3D; {
      formType: &#x27;program-dashboard&#x27;,
      formAction: &#x27;reportData&#x27;,
      contentType: &#x27;csv-dataset&#x27;,
      component: &#x27;portal&#x27;
    };

    this.formService.getFormConfig(formServiceInputParams).subscribe((formData) &#x3D;&gt; {
      if (formData) {
        this.formData &#x3D; formData;
      }
    }, error &#x3D;&gt; {
      this.toasterService.error(this.resourceService.messages.emsg.m0005);
    });

  }

  checkStatus() {
    let requestStatus &#x3D; true;
    const selectedReportList &#x3D; [];
    _.forEach(this.onDemandReportData, (value) &#x3D;&gt; {
      if (value.datasetConfig.type &#x3D;&#x3D; this.selectedReport.datasetId){
        _.forEach(value.datasetConfig.params.filters, (filter) &#x3D;&gt; {
          if([&#x27;solutionId&#x27;,&#x27;solution_id&#x27;].includes(filter[&#x27;dimension&#x27;]) &amp;&amp; filter.value  &#x3D;&#x3D;&#x3D; this.selectedSolution){
            selectedReportList.push(value);
          }
        });
      }
    });
    const sortedReportList &#x3D; _.sortBy(selectedReportList, [(data) &#x3D;&gt; {
      return data &amp;&amp; data.jobStats &amp;&amp; data.jobStats.dtJobSubmitted;
    }]);

    const reportListData &#x3D; _.last(sortedReportList) || {};
    if (!_.isEmpty(reportListData)) {
      const isInProgress &#x3D; this.onDemandReportService.isInProgress(reportListData, this.reportStatus);
      if (!isInProgress) {
        requestStatus &#x3D; true;
      } else {
        requestStatus &#x3D; false;
      }
    }
    return requestStatus;
  }
  onDownloadLinkFail(data) {
    const tagId &#x3D; data &amp;&amp; data.tag &amp;&amp; data.tag.split(&#x27;:&#x27;);
    this.onDemandReportService.getReport(_.head(tagId), data.requestId).subscribe((data: any) &#x3D;&gt; {
      if (data) {
        const downloadUrls &#x3D; _.get(data, &#x27;result.downloadUrls&#x27;) || [];
        const downloadPath &#x3D; _.head(downloadUrls);
        if (downloadPath) {
          window.open(downloadPath, &#x27;_blank&#x27;);
        } else {
          this.toasterService.error(_.get(this.resourceService, &#x27;messages.fmsg.m0004&#x27;));
        }
      }
    }, error &#x3D;&gt; {
      this.toasterService.error(_.get(this.resourceService, &#x27;messages.fmsg.m0004&#x27;));
    });
  }
  dataModification(row) {
    row.title &#x3D; row.datasetConfig.title;
    return row;
  }

  dateChanged($event, type) {
    if (moment($event.value).isValid()) {
      const year &#x3D; new Date($event.value._d).getFullYear();
      const month &#x3D; new Date($event.value._d).getMonth();
      const day &#x3D; new Date($event.value._d).getDate();
      if(type &#x3D;&#x3D;&#x3D; &#x27;startDate&#x27;){
        this.minEndDate &#x3D; new Date(year, month, day + 1);
        this.reportForm.controls.startDate.setValue(moment(_.get($event, &#x27;value._d&#x27;)).format(&#x27;YYYY-MM-DD&#x27;));
      }else{
        this.maxStartDate &#x3D; new Date(year, month, day - 1);
        this.reportForm.controls.endDate.setValue(moment(_.get($event, &#x27;value._d&#x27;)).format(&#x27;YYYY-MM-DD&#x27;));
      }
    }
  }

  closeDashboard(){
    this.location.back()
  }

  ngOnDestroy() {
    if (this.userDataSubscription) {
      this.userDataSubscription.unsubscribe();
    }
    this.unsubscribe$.next();
    this.unsubscribe$.complete();
  }
}
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'ConfigFilter.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
